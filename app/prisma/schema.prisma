// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  SECRETARY
  PATIENT
}

enum AppointmentStatus {
  TO_CONFIRM
  CONFIRMED
  IN_WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ConsentStatus {
  GRANTED
  REVOKED
  EXPIRED
}

enum StockMovementType {
  IN
  OUT
}

enum RecallStatus {
  PENDING
  CONTACTED
  COMPLETED
  SKIPPED
}

enum NotificationChannel {
  EMAIL
  SMS
  BOTH
}

enum PracticeClosureType {
  HOLIDAY
  TIME_OFF
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

enum RecurringMessageKind {
  HOLIDAY
  CLOSURE
  BIRTHDAY
}

enum RecurringMessageStatus {
  SENT
  FAILED
  SKIPPED
}

model FeatureUpdate {
  id           String   @id @default(cuid())
  title        String
  bodyMarkdown String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dismissals FeatureUpdateDismissal[]

  @@index([isActive, createdAt])
}

model FeatureUpdateDismissal {
  id              String   @id @default(cuid())
  userId          String
  featureUpdateId String
  dismissedAt     DateTime @default(now())

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureUpdate FeatureUpdate @relation(fields: [featureUpdateId], references: [id], onDelete: Cascade)

  @@unique([userId, featureUpdateId], name: "user_feature_update_unique")
  @@index([featureUpdateId])
  @@index([userId])
}

model RoleFeatureAccess {
  id      String  @id @default(cuid())
  role    Role
  feature String
  allowed Boolean @default(true)

  @@unique([role, feature], name: "role_feature_unique")
}

model SmsTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs SmsLog[]
}

model SmsLog {
  id         String   @id @default(cuid())
  to         String
  body       String
  status     String
  error      String?
  templateId String?
  patientId  String?
  userId     String?
  provider   String?
  createdAt  DateTime @default(now())

  template SmsTemplate? @relation(fields: [templateId], references: [id])
  patient  Patient?     @relation(fields: [patientId], references: [id])
  user     User?        @relation(fields: [userId], references: [id])

  @@index([to])
  @@index([createdAt])
}

model SmsProviderConfig {
  id        String   @id @default(cuid())
  username  String
  apiKey    String
  from      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  hashedPassword String?
  role           Role      @default(PATIENT)
  locale         String    @default("it")
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  avatarUrl      String?
  personalPin    String?   @unique
  gender         Gender    @default(NOT_SPECIFIED)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  doctor                  Doctor?
  auditLogs               AuditLog[]
  stockMovements          StockMovement[]          @relation("StockMovementUser")
  financeEntries          FinanceEntry[]           @relation("FinanceEntryUser")
  cashAdvances            CashAdvance[]            @relation("CashAdvanceUser")
  smsLogs                 SmsLog[]
  featureUpdateDismissals FeatureUpdateDismissal[]
  awards                  UserAward[]
  dentalRecordUpdates     DentalRecord[] @relation("DentalRecordUpdatedBy")
}

model Doctor {
  id        String   @id @default(cuid())
  fullName  String
  specialty String
  phone     String?
  notes     String?
  color     String? // Optional color code for agenda
  userId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                User?                      @relation(fields: [userId], references: [id])
  appointments        Appointment[]
  clinicalNotes       ClinicalNote[]
  financeEntries      FinanceEntry[]
  availabilityWindows DoctorAvailabilityWindow[]
  assignedAwards      UserAward[]                @relation("UserAwardDoctor")
}

model UserAward {
  id          String   @id @default(cuid())
  userId      String
  emoji       String
  title       String
  description String?
  doctorId    String?
  createdAt   DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor Doctor? @relation("UserAwardDoctor", fields: [doctorId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([doctorId])
}

model DoctorAvailabilityWindow {
  id          String   @id @default(cuid())
  doctorId    String
  /// ISO day of week (1=Monday ... 7=Sunday)
  dayOfWeek   Int
  /// Minutes from 00:00
  startMinute Int
  /// Minutes from 00:00
  endMinute   Int
  /// Optional color override for this availability block (hex string)
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek, startMinute, endMinute], name: "doctor_availability_unique")
  @@index([doctorId])
}

model PracticeClosure {
  id        String              @id @default(cuid())
  type      PracticeClosureType @default(HOLIDAY)
  title     String?
  startsAt  DateTime
  endsAt    DateTime
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([startsAt])
  @@index([endsAt])
}

model PracticeWeeklyClosure {
  id        String   @id @default(cuid())
  /// ISO day of week (1=Monday ... 7=Sunday)
  dayOfWeek Int      @unique
  title     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model RecurringMessageConfig {
  id            String               @id @default(cuid())
  kind          RecurringMessageKind @unique
  enabled       Boolean              @default(true)
  subject       String
  body          String
  daysBefore    Int? // Only used for closure reminders
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

model RecurringMessageLog {
  id           String               @id @default(cuid())
  kind         RecurringMessageKind
  patientId    String
  scheduledFor DateTime
  eventDate    DateTime?
  dedupeKey    String               @unique
  status       RecurringMessageStatus
  error        String?
  sentAt       DateTime?
  createdAt    DateTime             @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([kind, scheduledFor])
  @@index([patientId])
}

model Patient {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  birthDate DateTime?
  notes     String?
  photoUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  consents       PatientConsent[]
  appointments   Appointment[]
  appointmentReminders AppointmentReminder[]
  clinicalNotes  ClinicalNote[]
  recalls        Recall[]
  recurringMessageLogs RecurringMessageLog[]
  stockMovements StockMovement[]
  dentalRecords  DentalRecord[]
  smsLogs        SmsLog[]
  cashAdvances   CashAdvance[]
  quotes         Quote[]
}

model ConsentModule {
  id        String   @id @default(cuid())
  name      String
  content   String
  active    Boolean  @default(true)
  required  Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  consents PatientConsent[]

  @@unique([name])
}

model PatientConsent {
  id        String        @id @default(cuid())
  moduleId  String
  status    ConsentStatus @default(GRANTED)
  channel   String? // e.g. email/sms/firmato
  signatureUrl String?
  givenAt   DateTime      @default(now())
  signedOn  DateTime?
  expiresAt DateTime?
  revokedAt DateTime?
  place     String?
  patientName String?
  doctorName  String?
  patientId String

  patient Patient @relation(fields: [patientId], references: [id])
  module  ConsentModule @relation(fields: [moduleId], references: [id])

  @@unique([patientId, moduleId], name: "patientId_moduleId")
  @@index([patientId, moduleId])
}

model Appointment {
  id          String            @id @default(cuid())
  title       String
  status      AppointmentStatus @default(TO_CONFIRM)
  serviceType String
  startsAt    DateTime
  endsAt      DateTime
  notes       String?
  patientId   String
  doctorId    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])
  appointmentReminders AppointmentReminder[]

  @@index([startsAt])
  @@index([doctorId])
  @@index([patientId])
}

model ClinicalNote {
  id        String   @id @default(cuid())
  content   String
  patientId String
  doctorId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])

  @@index([patientId])
}

model DentalRecord {
  id          String   @id @default(cuid())
  patientId   String
  updatedById String?
  tooth       Int
  procedure   String
  notes       String?
  treated     Boolean  @default(false)
  performedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  updatedBy User?   @relation("DentalRecordUpdatedBy", fields: [updatedById], references: [id])

  @@index([patientId])
  @@index([patientId, tooth])
  @@index([updatedById])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  userId    String?
  role      Role?
  ip        String?
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
}

model Product {
  id           String   @id @default(cuid())
  name         String
  sku          String?  @unique
  udiDi        String? // Unique Device Identification - Device Identifier
  udiPi        String?
  brand        String?
  serviceType  String?
  unitCost     Decimal? @db.Decimal(10, 2)
  minThreshold Int      @default(0)
  supplierId   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  supplier       Supplier        @relation(fields: [supplierId], references: [id])
  stockMovements StockMovement[]

  @@index([name])
  @@index([udiDi])
}

model StockMovement {
  id        String            @id @default(cuid())
  productId String
  quantity  Int
  movement  StockMovementType
  note      String?
  createdAt DateTime          @default(now())
  userId    String?

  // Extended fields for implant registry
  udiPi            String? // Production Identifier (Lot, Serial, Expiry)
  interventionDate DateTime?
  interventionSite String?
  patientId        String?
  purchaseDate     DateTime?

  product Product  @relation(fields: [productId], references: [id])
  user    User?    @relation("StockMovementUser", fields: [userId], references: [id])
  patient Patient? @relation(fields: [patientId], references: [id])

  @@index([productId])
  @@index([movement])
  @@index([patientId])
}

model FinanceEntry {
  id          String   @id @default(cuid())
  type        String
  description String
  amount      Decimal  @db.Decimal(12, 2)
  occurredAt  DateTime
  doctorId    String?
  userId      String?
  createdAt   DateTime @default(now())

  doctor Doctor? @relation(fields: [doctorId], references: [id])
  user   User?   @relation("FinanceEntryUser", fields: [userId], references: [id])

  @@index([occurredAt])
  @@index([doctorId])
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  body        String
  buttonColor String?
  category    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CashAdvance {
  id        String   @id @default(cuid())
  patientId String
  amount    Decimal  @db.Decimal(12, 2)
  issuedAt  DateTime @default(now())
  note      String?
  userId    String?

  patient Patient @relation(fields: [patientId], references: [id])
  user    User?   @relation("CashAdvanceUser", fields: [userId], references: [id])

  @@index([patientId])
}

model RecallRule {
  id           String              @id @default(cuid())
  name         String
  serviceType  String
  intervalDays Int
  templateName String?
  message      String?
  emailSubject String?
  channel      NotificationChannel @default(EMAIL)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  recalls Recall[]
}

model Recall {
  id            String       @id @default(cuid())
  patientId     String
  ruleId        String
  dueAt         DateTime
  status        RecallStatus @default(PENDING)
  lastContactAt DateTime?
  notes         String?
  createdAt     DateTime     @default(now())

  patient Patient    @relation(fields: [patientId], references: [id])
  rule    RecallRule @relation(fields: [ruleId], references: [id])

  @@index([dueAt])
  @@index([status])
}

model AppointmentReminderRule {
  id           String              @id @default(cuid())
  daysBefore   Int
  channel      NotificationChannel @default(EMAIL)
  templateName String?
  emailSubject String?
  message      String?
  enabled      Boolean             @default(true)
  timingType   String              @default("DAYS_BEFORE")
  timeOfDayMinutes Int?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  reminders AppointmentReminder[]
}

model AppointmentReminder {
  id            String       @id @default(cuid())
  appointmentId String
  patientId     String
  ruleId        String
  dueAt         DateTime
  status        RecallStatus @default(PENDING)
  lastContactAt DateTime?
  createdAt     DateTime     @default(now())

  appointment Appointment           @relation(fields: [appointmentId], references: [id])
  patient     Patient               @relation(fields: [patientId], references: [id])
  rule        AppointmentReminderRule @relation(fields: [ruleId], references: [id])

  @@unique([appointmentId, ruleId])
  @@index([dueAt])
  @@index([status])
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  costBasis   Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quotes      Quote[]
  quoteItems  QuoteItem[]
}

model AnamnesisCondition {
  id        String   @id @default(cuid())
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Quote {
  id           String   @id @default(cuid())
  patientId    String
  serviceId    String
  serviceName  String
  quantity     Int      @default(1)
  price        Decimal  @db.Decimal(12, 2)
  total        Decimal  @db.Decimal(12, 2)
  signatureUrl String
  signedAt     DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])
  items   QuoteItem[]

  @@index([patientId, createdAt])
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  serviceId   String
  serviceName String
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  saldato     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quote   Quote   @relation(fields: [quoteId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  @@index([quoteId])
}

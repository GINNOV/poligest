// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  SECRETARY
  PATIENT
}

enum AppointmentStatus {
  TO_CONFIRM
  CONFIRMED
  IN_WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ConsentType {
  PRIVACY
  MARKETING
  TREATMENT
  RECALL
}

enum ConsentStatus {
  GRANTED
  REVOKED
  EXPIRED
}

enum StockMovementType {
  IN
  OUT
}

enum RecallStatus {
  PENDING
  CONTACTED
  COMPLETED
  SKIPPED
}

enum NotificationChannel {
  EMAIL
  SMS
  BOTH
}

enum PracticeClosureType {
  HOLIDAY
  TIME_OFF
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

model FeatureUpdate {
  id           String   @id @default(cuid())
  title        String
  bodyMarkdown String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dismissals FeatureUpdateDismissal[]

  @@index([isActive, createdAt])
}

model FeatureUpdateDismissal {
  id             String   @id @default(cuid())
  userId         String
  featureUpdateId String
  dismissedAt    DateTime @default(now())

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureUpdate FeatureUpdate @relation(fields: [featureUpdateId], references: [id], onDelete: Cascade)

  @@unique([userId, featureUpdateId], name: "user_feature_update_unique")
  @@index([featureUpdateId])
  @@index([userId])
}

model RoleFeatureAccess {
  id      String @id @default(cuid())
  role    Role
  feature String
  allowed Boolean @default(true)

  @@unique([role, feature], name: "role_feature_unique")
}

model SmsTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs SmsLog[]
}

model SmsLog {
  id          String    @id @default(cuid())
  to          String
  body        String
  status      String
  error       String?
  templateId  String?
  patientId   String?
  userId      String?
  provider    String?
  createdAt   DateTime  @default(now())

  template SmsTemplate? @relation(fields: [templateId], references: [id])
  patient  Patient?     @relation(fields: [patientId], references: [id])
  user     User?        @relation(fields: [userId], references: [id])

  @@index([to])
  @@index([createdAt])
}

model SmsProviderConfig {
  id        String   @id @default(cuid())
  username  String
  apiKey    String
  from      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  hashedPassword String?
  role           Role      @default(PATIENT)
  locale         String    @default("it")
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  avatarUrl      String?
  personalPin    String?   @unique
  gender         Gender    @default(NOT_SPECIFIED)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  doctor         Doctor?
  auditLogs      AuditLog[]
  stockMovements StockMovement[] @relation("StockMovementUser")
  financeEntries FinanceEntry[]  @relation("FinanceEntryUser")
  cashAdvances   CashAdvance[]   @relation("CashAdvanceUser")
  smsLogs        SmsLog[]
  featureUpdateDismissals FeatureUpdateDismissal[]
  awards         UserAward[]
}

model Doctor {
  id        String   @id @default(cuid())
  fullName  String
  specialty String
  phone     String?
  notes     String?
  color     String? // Optional color code for agenda
  userId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User?          @relation(fields: [userId], references: [id])
  appointments   Appointment[]
  clinicalNotes  ClinicalNote[]
  financeEntries FinanceEntry[]
  cashAdvances   CashAdvance[]
  availabilityWindows DoctorAvailabilityWindow[]
  assignedAwards UserAward[] @relation("UserAwardDoctor")
}

model UserAward {
  id          String   @id @default(cuid())
  userId      String
  emoji       String
  title       String
  description String?
  doctorId    String?
  createdAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor Doctor? @relation("UserAwardDoctor", fields: [doctorId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([doctorId])
}

model DoctorAvailabilityWindow {
  id          String   @id @default(cuid())
  doctorId    String
  /// ISO day of week (1=Monday ... 7=Sunday)
  dayOfWeek   Int
  /// Minutes from 00:00
  startMinute Int
  /// Minutes from 00:00
  endMinute   Int
  /// Optional color override for this availability block (hex string)
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@unique([doctorId, dayOfWeek, startMinute, endMinute], name: "doctor_availability_unique")
}

model PracticeClosure {
  id        String              @id @default(cuid())
  type      PracticeClosureType @default(HOLIDAY)
  title     String?
  startsAt  DateTime
  endsAt    DateTime
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([startsAt])
  @@index([endsAt])
}

model PracticeWeeklyClosure {
  id        String   @id @default(cuid())
  /// ISO day of week (1=Monday ... 7=Sunday)
  dayOfWeek Int      @unique
  title     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Patient {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  birthDate DateTime?
  notes     String?
  photoUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  consents       Consent[]
  appointments   Appointment[]
  clinicalNotes  ClinicalNote[]
  recalls        Recall[]
  stockMovements StockMovement[]
  dentalRecords  DentalRecord[]
  smsLogs        SmsLog[]
}

model Consent {
  id        String        @id @default(cuid())
  type      ConsentType
  status    ConsentStatus @default(GRANTED)
  channel   String? // e.g. email/sms/firmato
  givenAt   DateTime      @default(now())
  expiresAt DateTime?
  revokedAt DateTime?
  patientId String

  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([patientId, type], name: "patientId_type")
  @@index([patientId, type])
}

model Appointment {
  id          String            @id @default(cuid())
  title       String
  status      AppointmentStatus @default(TO_CONFIRM)
  serviceType String
  startsAt    DateTime
  endsAt      DateTime
  notes       String?
  patientId   String
  doctorId    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])

  @@index([startsAt])
  @@index([doctorId])
  @@index([patientId])
}

model ClinicalNote {
  id        String   @id @default(cuid())
  content   String
  patientId String
  doctorId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])

  @@index([patientId])
}

model DentalRecord {
  id          String   @id @default(cuid())
  patientId   String
  tooth       Int
  procedure   String
  notes       String?
  performedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([patientId, tooth])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  userId    String?
  role      Role?
  ip        String?
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
}

model Product {
  id           String   @id @default(cuid())
  name         String
  sku          String?  @unique
  udiDi        String? // Unique Device Identification - Device Identifier
  serviceType  String?
  unitCost     Decimal? @db.Decimal(10, 2)
  minThreshold Int      @default(0)
  supplierId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  stockMovements StockMovement[]

  @@index([name])
  @@index([udiDi])
}

model StockMovement {
  id        String            @id @default(cuid())
  productId String
  quantity  Int
  movement  StockMovementType
  note      String?
  createdAt DateTime          @default(now())
  userId    String?

  // Extended fields for implant registry
  udiPi            String? // Production Identifier (Lot, Serial, Expiry)
  interventionDate DateTime?
  interventionSite String?
  patientId        String?
  purchaseDate     DateTime?

  product Product  @relation(fields: [productId], references: [id])
  user    User?    @relation("StockMovementUser", fields: [userId], references: [id])
  patient Patient? @relation(fields: [patientId], references: [id])

  @@index([productId])
  @@index([movement])
  @@index([patientId])
}

model FinanceEntry {
  id          String   @id @default(cuid())
  type        String
  description String
  amount      Decimal  @db.Decimal(12, 2)
  occurredAt  DateTime
  doctorId    String?
  userId      String?
  createdAt   DateTime @default(now())

  doctor Doctor? @relation(fields: [doctorId], references: [id])
  user   User?   @relation("FinanceEntryUser", fields: [userId], references: [id])

  @@index([occurredAt])
  @@index([doctorId])
}

model CashAdvance {
  id       String   @id @default(cuid())
  doctorId String
  amount   Decimal  @db.Decimal(12, 2)
  issuedAt DateTime @default(now())
  note     String?
  userId   String?

  doctor Doctor @relation(fields: [doctorId], references: [id])
  user   User?  @relation("CashAdvanceUser", fields: [userId], references: [id])

  @@index([doctorId])
}

model RecallRule {
  id           String               @id @default(cuid())
  name         String
  serviceType  String
  intervalDays Int
  message      String?
  emailSubject String?
  channel      NotificationChannel @default(EMAIL)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  recalls Recall[]
}

model Recall {
  id            String       @id @default(cuid())
  patientId     String
  ruleId        String
  dueAt         DateTime
  status        RecallStatus @default(PENDING)
  lastContactAt DateTime?
  notes         String?
  createdAt     DateTime     @default(now())

  patient Patient    @relation(fields: [patientId], references: [id])
  rule    RecallRule @relation(fields: [ruleId], references: [id])

  @@index([dueAt])
  @@index([status])
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  costBasis   Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
